---
title: "IDDAP"
author: "Infectious Diseases Data Analysis Program"
output: 
  flexdashboard::flex_dashboard:
    source: embed
    runtime: shiny
    orientation: rows
    vertical_layout: fill
    theme: cerulean
---

```{r setup}
library(flexdashboard)
library(ggplot2)
library(mgcv)
library(shiny)
library(dplyr)
library(readr)
library(RColorBrewer)
library(DT)
```

Sidebar {.sidebar data-width=250} 
===================================== 
```{r}
fileInput('file1', h5("Please Select a file to Upload"),accept=c('text/csv','text/comma-separated-values','text/tab-separated-values','text/plain','.csv','.tsv'))
h4("Filters:")
sliderInput('age', "Age Range", min = 0, max = 110, value=c(0, 110) )
sliderInput('weight', "Weight Range (kgs) ", min = 0, max = 150, value=c(0, 150))
sliderInput('height', "Height Range (m) ", min = 0, max = 2.5, value=c(0, 2.5))
dateRangeInput('OPATad', "Admittance to the OPAT Program", start= "2005-01-01",end= "2020-01-01", min = "2005-01-01", max ="2020-01-01", separator = " - ", format = "yyyy/mm/dd", startview="year")
checkboxGroupInput("resis", "Resistant Infection? (deselection will filter out the option)", choices= c("Yes"=1, "No"=2), selected = c(1,2))
checkboxGroupInput("riskofre", "High Risk of Readmission? (deselection will filter out the option)", choices= c("Yes"=1, "No"=2), selected = c(1,2))
checkboxGroupInput("MF", "Gender: (deselection will filter out the option)", choices= c("Male", "Female"), selected = c("Male", "Female"))
checkboxGroupInput("AB", "Antibiotic Type: (deselection will filter out the option)", choices= c("Erythromycin"=1, "Lymecycline"=2, "Norfloxacin"=3, "Ciprofloxacin"=4, "Amoxicillin"=5, 	"Gentamicin"=6,"Phenoxymethylpenicillin"=7, "Other"=8), selected = c(1, 2, 3, 4, 5, 6, 7, 8))
```

File Manipulation
===================================== 

Output Column {.tabset .tabset-fade}
-------------------------------------
### Patient Data Results
```{r}
renderDataTable({
  if(is.null(input$file1))
  return()
  newdata<-read_csv(input$file1$datapath)
  assign('inputfile',newdata)
  
  # Age input conditionals
  inputfile<- filter(inputfile,`Age`>=as.numeric(input$age[1]))
  inputfile<- filter(inputfile,`Age`<=as.numeric(input$age[2]))
  # Weight input conditionals
  inputfile<- filter(inputfile,`Weight (kgs)`>=as.numeric(input$weight[1]))
  inputfile<- filter(inputfile,`Weight (kgs)`<=as.numeric(input$weight[2]))  
  # Height input conditionals
  inputfile<- filter(inputfile,`Height (m)`>=as.numeric(input$height[1]))
  inputfile<- filter(inputfile,`Height (m)`<=as.numeric(input$height[2]))
  
  # Date input conditionals
    inputfile<- filter(inputfile, (as.integer(input$OPATad[1]-as.Date.character(`OPAT Start Date`,"%m/%d/%Y"))) < 0)
    inputfile<- filter(inputfile, (as.integer(input$OPATad[2]-as.Date.character(`OPAT Start Date`,"%m/%d/%Y"))) > 0)
  
  # Risk of readmission checkbox group
  if("1" %in% input$riskofre==FALSE )
    inputfile<- filter(inputfile,`High Risk of Readmission`=='Y')
  if("2" %in% input$riskofre==FALSE)
    inputfile<- filter(inputfile,`High Risk of Readmission` %in% c('N','No', 'NO'))
  if(is.null(input$riskofre))
    inputfile <- "please mark whether the patient is at risk for readmission"
  
  # Resistant Checkbox Group conditionals
  if("1" %in% input$resis==FALSE )
    inputfile<- filter(inputfile,`Resistant Organism (Y/N)`=='N')
  if("2" %in% input$resis==FALSE )
    inputfile<- filter(inputfile,`Resistant Organism (Y/N)`=='Y')
  if(is.null(input$resis))
    inputfile <- "please select a resistance"
  
  # Antibiotic Type Checkbox Group conditionals
  if("1" %in% input$AB==FALSE )
    inputfile<- filter(inputfile,`Antibiotic`!='erythromycin')
  if("2" %in% input$AB==FALSE )
    inputfile<- filter(inputfile,`Antibiotic`!='lymecycline')
  if("3" %in% input$AB==FALSE )
    inputfile<- filter(inputfile,`Antibiotic`!='norfloxacin')
  if("4" %in% input$AB==FALSE )
    inputfile<- filter(inputfile,`Antibiotic`!='ciprofloxacin')
  if("5" %in% input$AB==FALSE )
    inputfile<- filter(inputfile,`Antibiotic`!='amoxicillin')
  if("6" %in% input$AB==FALSE )
    inputfile<- filter(inputfile,`Antibiotic`!='gentamicin')
  if("7" %in% input$AB==FALSE )
    inputfile<- filter(inputfile,`Antibiotic`!='phenoxymethylpenicillin')
  if(is.null(input$AB))
    inputfile <- "please select an antibiotic type"
  # needed at the very end to return the modified inputfile
  inputfile
})

```

### Original File
```{r}
renderTable({
  if(is.null(input$file1))
  return()
  newdata<-read_csv(input$file1$datapath)
  assign('original',newdata)
  original
})
```

Data Analytics
===================================== 

Row1 { data-height=50}
-----------------------------------------------------------------------
```{r}
h4("Select Graphical Output:")
```

Row 2 {.tabset .tabset-fade}
-------------------------------------

### Bar Graph 
```{r}
renderPlot({
  if(is.null(input$file1))
  return()
  newdata<-read_csv(input$file1$datapath)
  assign('inputfile',newdata)
  #do things to modify the "input file" below here"
  
  # Age input conditionals
  inputfile<- filter(inputfile,`Age`>=as.numeric(input$age[1]))
  inputfile<- filter(inputfile,`Age`<=as.numeric(input$age[2]))
  # Weight input conditionals
  inputfile<- filter(inputfile,`Weight (kgs)`>=as.numeric(input$weight[1]))
  inputfile<- filter(inputfile,`Weight (kgs)`<=as.numeric(input$weight[2]))  
  # Height input conditionals
  inputfile<- filter(inputfile,`Height (m)`>=as.numeric(input$height[1]))
  inputfile<- filter(inputfile,`Height (m)`<=as.numeric(input$height[2]))
  
  # Date input conditionals
inputfile<- filter(inputfile, (as.integer(input$OPATad[1]-as.Date.character(`OPAT Start Date`,"%m/%d/%Y"))) < 0)
inputfile<- filter(inputfile, (as.integer(input$OPATad[2]-as.Date.character(`OPAT Start Date`,"%m/%d/%Y"))) > 0)
  
  # Risk of readmission checkbox group
  if("1" %in% input$riskofre==FALSE )
    inputfile<- filter(inputfile,`High Risk of Readmission`=='Y')
  if("2" %in% input$riskofre==FALSE)
    inputfile<- filter(inputfile,`High Risk of Readmission`=='N')
  if(is.null(input$riskofre))
    inputfile <- "please mark whether the patient is at risk for readmission"
  
  # Resistant Checkbox Group conditionals
  if("1" %in% input$resis==FALSE )
    inputfile<- filter(inputfile,`Resistant Organism (Y/N)`=='N')
  if("2" %in% input$resis==FALSE )
    inputfile<- filter(inputfile,`Resistant Organism (Y/N)`=='Y')
  if(is.null(input$resis))
    inputfile <- "please select a resistance"
  
  # Antibiotic Type Checkbox Group conditionals
  if("1" %in% input$AB==FALSE )
    inputfile<- filter(inputfile,`Antibiotic`!='erythromycin')
  if("2" %in% input$AB==FALSE )
    inputfile<- filter(inputfile,`Antibiotic`!='lymecycline')
  if("3" %in% input$AB==FALSE )
    inputfile<- filter(inputfile,`Antibiotic`!='norfloxacin')
  if("4" %in% input$AB==FALSE )
    inputfile<- filter(inputfile,`Antibiotic`!='ciprofloxacin')
  if("5" %in% input$AB==FALSE )
    inputfile<- filter(inputfile,`Antibiotic`!='amoxicillin')
  if("6" %in% input$AB==FALSE )
    inputfile<- filter(inputfile,`Antibiotic`!='gentamicin')
  if("7" %in% input$AB==FALSE )
    inputfile<- filter(inputfile,`Antibiotic`!='phenoxymethylpenicillin')
  if(is.null(input$AB))
    inputfile <- "please select an antibiotic type"
ggplot(inputfile,aes(x=Antibiotic))+geom_bar(fill=brewer.pal(7,"Set2"))+ylab("Numer of Patients Taking Antibiotic")

})
```

### Antibiotic Resistance 
```{r}
renderPlot({
  if(is.null(input$file1))
  return()
  newdata<-read_csv(input$file1$datapath)
  assign('inputfile',newdata)
  #do things to modify the "input file" below here"
  
  # Age input conditionals
  inputfile<- filter(inputfile,`Age`>=as.numeric(input$age[1]))
  inputfile<- filter(inputfile,`Age`<=as.numeric(input$age[2]))
  # Weight input conditionals
  inputfile<- filter(inputfile,`Weight (kgs)`>=as.numeric(input$weight[1]))
  inputfile<- filter(inputfile,`Weight (kgs)`<=as.numeric(input$weight[2]))  
  # Height input conditionals
  inputfile<- filter(inputfile,`Height (m)`>=as.numeric(input$height[1]))
  inputfile<- filter(inputfile,`Height (m)`<=as.numeric(input$height[2]))
  
  # Date input conditionals
inputfile<- filter(inputfile, (as.integer(input$OPATad[1]-as.Date.character(`OPAT Start Date`,"%m/%d/%Y"))) < 0)
inputfile<- filter(inputfile, (as.integer(input$OPATad[2]-as.Date.character(`OPAT Start Date`,"%m/%d/%Y"))) > 0)
  
  # Risk of readmission checkbox group
  if("1" %in% input$riskofre==FALSE )
    inputfile<- filter(inputfile,`High Risk of Readmission`=='Y')
  if("2" %in% input$riskofre==FALSE)
    inputfile<- filter(inputfile,`High Risk of Readmission`=='N')
  if(is.null(input$riskofre))
    inputfile <- "please mark whether the patient is at risk for readmission"
  
  # Resistant Checkbox Group conditionals
  if("1" %in% input$resis==FALSE )
    inputfile<- filter(inputfile,`Resistant Organism (Y/N)`=='N')
  if("2" %in% input$resis==FALSE )
    inputfile<- filter(inputfile,`Resistant Organism (Y/N)`=='Y')
  if(is.null(input$resis))
    inputfile <- "please select a resistance"
  
  # Antibiotic Type Checkbox Group conditionals
  if("1" %in% input$AB==FALSE )
    inputfile<- filter(inputfile,`Antibiotic`!='erythromycin')
  if("2" %in% input$AB==FALSE )
    inputfile<- filter(inputfile,`Antibiotic`!='lymecycline')
  if("3" %in% input$AB==FALSE )
    inputfile<- filter(inputfile,`Antibiotic`!='norfloxacin')
  if("4" %in% input$AB==FALSE )
    inputfile<- filter(inputfile,`Antibiotic`!='ciprofloxacin')
  if("5" %in% input$AB==FALSE )
    inputfile<- filter(inputfile,`Antibiotic`!='amoxicillin')
  if("6" %in% input$AB==FALSE )
    inputfile<- filter(inputfile,`Antibiotic`!='gentamicin')
  if("7" %in% input$AB==FALSE )
    inputfile<- filter(inputfile,`Antibiotic`!='phenoxymethylpenicillin')
  if(is.null(input$AB))
    inputfile <- "please select an antibiotic type"

#says that Resistant.Organism..Y.N. does not exist- i cant figure it out
ggplot(inputfile,aes(x=Antibiotic,fill=Resistant.Organism..Y.N.))+geom_bar(position="fill")+labs(x="Antibiotic",y="Number of Patients")+theme(axis.text.x=element_text(angle=30),plot.title=element_text(hjust=0.5))
})
```

### Averages
```{r}
"to be added"
```

About
===================================== 
Row 1 {.tabset .tabset-fade data-height=100}
-----------------------------------------------------------------------
### Instructions
```{r}
"go"
```
### Significance of Innovation
```{r}
"wow"
```

